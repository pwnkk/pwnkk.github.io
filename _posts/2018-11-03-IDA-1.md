---
layout: post
title:  "C++ 逆向"
date:   2018-02-10 15:14:54
excerpt: "C++ 逆向"
categories: reverse
---

## 0x00 介绍
博客第一篇补充一下基础知识，了解C++的类和虚表等结构也可以为C++ pwn 打好基础。

###类
```
#include<stdio.h>
class c
{
private:
    int v1;
    int v2;
public:
    c(){
        v1=123;
        v2=234;
    };
    c(int a,int  b){
        v1=a;
        v2=b;
    };
    void dump(){
        printf("v1=%d,v2=%d\n",v1,v2);
    }
};
int main(){
    class c c1;
    class c c2(111,222);
    c1.dump();
    c2.dump();
}
//g++ class.cpp -o class
```

```
0000000000400596 <main>:
  400596:       55                      push   rbp
  400597:       48 89 e5                mov    rbp,rsp
  40059a:       48 83 ec 20             sub    rsp,0x20
  40059e:       64 48 8b 04 25 28 00    mov    rax,QWORD PTR fs:0x28
  4005a5:       00 00
  4005a7:       48 89 45 f8             mov    QWORD PTR [rbp-0x8],rax
  4005ab:       31 c0                   xor    eax,eax
  4005ad:       48 8d 45 e0             lea    rax,[rbp-0x20]
  4005b1:       48 89 c7                mov    rdi,rax
  4005b4:       e8 49 00 00 00          call   400602 <_ZN1cC1Ev>
  4005b9:       48 8d 45 f0             lea    rax,[rbp-0x10]
  4005bd:       ba de 00 00 00          mov    edx,0xde
  4005c2:       be 6f 00 00 00          mov    esi,0x6f
  4005c7:       48 89 c7                mov    rdi,rax
  4005ca:       e8 53 00 00 00          call   400622 <_ZN1cC1Eii>
  4005cf:       48 8d 45 e0             lea    rax,[rbp-0x20]
  4005d3:       48 89 c7                mov    rdi,rax
  4005d6:       e8 6b 00 00 00          call   400646 <_ZN1c4dumpEv>
  4005db:       48 8d 45 f0             lea    rax,[rbp-0x10]
  4005df:       48 89 c7                mov    rdi,rax
  4005e2:       e8 5f 00 00 00          call   400646 <_ZN1c4dumpEv>
  4005e7:       b8 00 00 00 00          mov    eax,0x0
  4005ec:       48 8b 4d f8             mov    rcx,QWORD PTR [rbp-0x8]
  4005f0:       64 48 33 0c 25 28 00    xor    rcx,QWORD PTR fs:0x28
  4005f7:       00 00
  4005f9:       74 05                   je     400600 <main+0x6a>
  4005fb:       e8 60 fe ff ff          call   400460 <__stack_chk_fail@plt>
  400600:       c9                      leave
  400601:       c3                      ret
```
函数首先开辟0x20 字节空间用于存放对象，rbp-0x10 和 rbp-0x20
对象初始化时，将对象地址作为第一参数调用了 <_ZN1cC1Ev> ，在需要传参的<_ZN1cC1Eii>函数中使用rdi传递this指针(MSVC中是使用rcx传递)，rsi，rdx存放第二，三两个参数。
   

###虚函数
C++中虚函数是为了实现多态的机制而创造。一个派生类中定义了和基类中同样函数名的函数。
```
#include<stdio.h>
class A
{
    public:
        virtual void foo(){
            printf("class A foo\n");
        };
};

class B: public A
{
    public:
        virtual void foo(){
            printf("class B foo\n");
        };

};
int main(){
    class A a;
    class B b;
    a.foo();   // class A foo
    b.foo();   //  class B foo
}
//g++ vtable.cpp -o vtable
```

```
0000000000400716 <main>:
  400716:       55                      push   rbp
  400717:       48 89 e5                mov    rbp,rsp
  40071a:       48 83 ec 20             sub    rsp,0x20
  40071e:       64 48 8b 04 25 28 00    mov    rax,QWORD PTR fs:0x28
  400725:       00 00
  400727:       48 89 45 f8             mov    QWORD PTR [rbp-0x8],rax
  40072b:       31 c0                   xor    eax,eax
  40072d:       48 8d 45 e0             lea    rax,[rbp-0x20]
  400731:       48 89 c7                mov    rdi,rax
  400734:       e8 73 00 00 00          call   4007ac <_ZN1AC1Ev>
  400739:       48 8d 45 f0             lea    rax,[rbp-0x10]
  40073d:       48 89 c7                mov    rdi,rax
  400740:       e8 7f 00 00 00          call   4007c4 <_ZN1BC1Ev>
  400745:       48 8d 45 e0             lea    rax,[rbp-0x20]
  400749:       48 89 c7                mov    rdi,rax
  40074c:       e8 27 00 00 00          call   400778 <_ZN1A3fooEv>
  400751:       48 8d 45 f0             lea    rax,[rbp-0x10]
  400755:       48 89 c7                mov    rdi,rax
  400758:       e8 35 00 00 00          call   400792 <_ZN1B3fooEv>
  40075d:       b8 00 00 00 00          mov    eax,0x0
  400762:       48 8b 55 f8             mov    rdx,QWORD PTR [rbp-0x8]
  400766:       64 48 33 14 25 28 00    xor    rdx,QWORD PTR fs:0x28
  40076d:       00 00
  40076f:       74 05                   je     400776 <main+0x60>
  400771:       e8 8a fe ff ff          call   400600 <__stack_chk_fail@plt>
  400776:       c9                      leave
  400777:       c3                      ret

```



